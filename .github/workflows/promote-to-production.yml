name: ðŸ§  Promote Dev to Production

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "PROMOTE" to confirm promotion to production'
        required: true
        default: 'PROMOTE'

permissions:
  contents: write

jobs:
  promote:
    name: Promote Development to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: Validate promotion confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "PROMOTE" ]; then
            echo "âŒ Promotion cancelled. Please type 'PROMOTE' to confirm."
            exit 1
          fi
          echo "âœ… Production promotion confirmed!"

      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Display promotion info
        run: |
          echo "ðŸ§  PROMOTING PSYCHOLOGY WEBSITE TO PRODUCTION"
          echo "============================================="
          echo "Source Branch: main (development)"
          echo "Target Branch: production"
          echo "Latest Commit: $(git log -1 --oneline)"
          echo "Commit Hash: $(git rev-parse HEAD)"

      - name: Configure git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Create/Update production branch
        run: |
          echo "ðŸ”„ Creating/updating production branch..."
          
          # Fetch all branches
          git fetch origin
          
          # Check if production branch exists
          if git show-ref --verify --quiet refs/remotes/origin/production; then
            echo "ðŸ“‹ Production branch exists, updating..."
            git checkout production
            git merge main --no-ff -m "feat: promote main to production - $(date)"
          else
            echo "ðŸ“‹ Creating new production branch..."
            git checkout -b production
          fi
          
          # Push production branch
          git push origin production
          
          echo "âœ… Production branch updated successfully!"

      - name: Trigger production deployment
        run: |
          echo "ðŸš€ Triggering production deployment..."
          
          # Trigger the production deployment workflow
          gh workflow run deploy-production.yml --ref production || echo "âš ï¸  Production deployment workflow will be triggered automatically"

      - name: Promotion Summary
        run: |
          echo "## ðŸ§  Psychology Website - Promotion to Production Complete!" > $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… Successfully promoted to production" >> $GITHUB_STEP_SUMMARY
          echo "**Promoted by:** $GITHUB_ACTOR" >> $GITHUB_STEP_SUMMARY
          echo "**Source:** main branch (development)" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** production branch" >> $GITHUB_STEP_SUMMARY
          echo "**Latest commit:** $(git log -1 --oneline)" >> $GITHUB_STEP_SUMMARY
          echo "**Commit hash:** $(git rev-parse HEAD)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ§  What was promoted:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… All development changes from main branch" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Latest psychology website features" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Mental health content updates" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… UI/UX improvements" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Performance optimizations" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Production deployment will be triggered automatically" >> $GITHUB_STEP_SUMMARY
          echo "2. Monitor production deployment status" >> $GITHUB_STEP_SUMMARY
          echo "3. Verify custom domain is working correctly" >> $GITHUB_STEP_SUMMARY
          echo "4. Test all functionality on production" >> $GITHUB_STEP_SUMMARY
