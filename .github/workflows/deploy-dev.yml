name: ðŸ§  Deploy to Development (Amplify)

on:
  push:
    branches:
      - main
  workflow_dispatch: {}

permissions:
  contents: read

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AMPLIFY_APP_ID: ${{ secrets.AMPLIFY_APP_ID }}
  AMPLIFY_BRANCH: ${{ secrets.AMPLIFY_BRANCH }}

jobs:
  deploy:
    name: Deploy to Development
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq zip

      - name: Create deployment package
        run: |
          echo "ðŸ“¦ Creating deployment package for Psychology Website..."
          
          # Create clean deployment package
          zip -r psychology-deploy.zip . \
            -x ".git/*" \
            -x ".github/*" \
            -x "*.log" \
            -x "backups/*" \
            -x "temp/*" \
            -x "logs/*"
          
          echo "ðŸ“Š Package size: $(du -h psychology-deploy.zip)"
          echo "ðŸ“‹ Package contents:"
          unzip -l psychology-deploy.zip | head -10

      - name: Deploy to Amplify Development
        run: |
          echo "ðŸ§  Starting Amplify development deployment..."
          
          # Create deployment
          echo "Creating Amplify deployment..."
          DEPLOY_RESPONSE=$(aws amplify create-deployment \
            --app-id "${AMPLIFY_APP_ID}" \
            --branch-name "${AMPLIFY_BRANCH}" \
            --output json)
          
          echo "Deploy response: $DEPLOY_RESPONSE"
          
          # Extract job ID and upload URL
          JOB_ID=$(echo "$DEPLOY_RESPONSE" | jq -r '.jobId')
          UPLOAD_URL=$(echo "$DEPLOY_RESPONSE" | jq -r '.zipUploadUrl')
          
          echo "Job ID: $JOB_ID"
          echo "Upload URL: $UPLOAD_URL"
          
          # Validate response
          if [ "$JOB_ID" = "null" ] || [ "$UPLOAD_URL" = "null" ] || [ -z "$JOB_ID" ] || [ -z "$UPLOAD_URL" ]; then
            echo "âŒ Failed to get deployment details"
            echo "Response: $DEPLOY_RESPONSE"
            exit 1
          fi
          
          # Upload files
          echo "ðŸ“¤ Uploading files to Amplify..."
          curl -X PUT -T psychology-deploy.zip -H "Content-Type: application/zip" "$UPLOAD_URL"
          
          if [ $? -eq 0 ]; then
            echo "âœ… Upload successful"
          else
            echo "âŒ Upload failed"
            exit 1
          fi
          
          # Start deployment
          echo "ðŸš€ Starting deployment..."
          aws amplify start-deployment \
            --app-id "${AMPLIFY_APP_ID}" \
            --branch-name "${AMPLIFY_BRANCH}" \
            --job-id "$JOB_ID"
          
          echo "âœ… Development deployment initiated successfully!"

      - name: Deployment Summary
        run: |
          echo "## ðŸ§  Psychology Website - Development Deployment Complete!" > $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… Successfully deployed to development" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** $GITHUB_ACTOR" >> $GITHUB_STEP_SUMMARY
          echo "**Source:** main branch" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** Development environment" >> $GITHUB_STEP_SUMMARY
          echo "**Latest commit:** $(git log -1 --oneline)" >> $GITHUB_STEP_SUMMARY
          echo "**Commit hash:** $(git rev-parse HEAD)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ§  Psychology Website Features:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Professional psychology consultation services" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Mental health awareness content" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Contact forms and consultation booking" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Mobile-responsive design" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… SEO optimized for psychology services" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Check your development URL in a few minutes" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify all changes are live" >> $GITHUB_STEP_SUMMARY
          echo "3. Test all functionality before production deployment" >> $GITHUB_STEP_SUMMARY
